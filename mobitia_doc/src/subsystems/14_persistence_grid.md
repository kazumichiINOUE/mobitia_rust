# 2.14 Local Persistence Grid (動的障害物の安定化)
<!-- TODO: Add English translation here -->

LiDARによる生のスキャンデータには、センサノイズや計測誤差による「チラつき (Flickering)」が含まれます。これをそのまま経路計画（Elastic Band）に入力すると、経路が不安定に振動し、制御の乱れや蛇行を引き起こします。

Mobitiaでは、この問題に対処するために **Local Persistence Grid (局所持続性グリッド)** と呼ばれるフィルタリング層を導入しています。これは、確率論的な占有格子地図（Occupancy Grid Map）と似ていますが、より軽量で反応速度に優れた「カウンタベース」のフィルタです。

## 背景と目的
<!-- TODO: Add English translation here -->

通常の2D-LiDAR点群はスパース（疎）であり、壁などの連続した物体であっても、フレームごとに計測点が微妙にずれたり、欠落したりします。また、空中の塵や床面の反射によるゴースト点が一瞬だけ現れることもあります。

*   **課題:**
    *   **経路の振動:** 1フレームだけのノイズにEBが反応して経路を変形させてしまう。
    *   **すり抜け:** スパースな点群の間を「通れる」と誤認してしまう。

これに対し、ROSのCostmap2Dなどは「レイキャスティングによる確率更新」を行いますが、計算負荷が高く、また移動物体に対する反応（消去）が遅れる傾向があります。Mobitiaでは、**「実在する障害物は、同じ場所に留まり続ける」** という物理的性質を利用し、シンプルかつ高速なフィルタを実装しました。

## アルゴリズム (`src/navigation/persistence_grid.rs`)
<!-- TODO: Add English translation here -->

本手法は、ロボットの周囲を覆うグリッドマップ上で、各セルに「障害物の存在強度（カウンタ）」を持たせるものです。

### 1. グリッドの定義
*   **座標系:** グローバル座標系（Map Frame）で管理されるスパースなハッシュマップ (`HashMap<(ix, iy), count>`)。
    *   ロボットが移動しても、壁（静止物）のグリッド座標は変わらないため、安定してカウントを蓄積できます。
*   **解像度:** `0.1m` (10cm)。
    *   SLAM用の地図（2.5cm）よりもあえて粗くすることで、LiDARの計測ブレを吸収し、障害物を「面」として安定させます。

### 2. 更新プロセス (Update Loop)
毎フレーム、以下の手順でグリッドを更新します。

#### Step 1: 減衰 (Decay)
全てのセルのカウンタを一律に減らします。

$$ C_{t} = C_{t-1} - \text{decay\_amount} $$

*   $C_t \le 0$ となったセルは即座に削除されます。これにより、移動して去った障害物やノイズは速やかに消滅します。

#### Step 2: 加算 (Hit)
現在のLiDARスキャン点群が含まれるセルに対し、カウンタを加算します。

$$ C_{t} = \min(C_{t} + \text{hit\_increment}, \text{max\_value}) $$

#### Step 3: フィルタリング (Thresholding)
カウンタが閾値を超えているセルの中心座標のみを、有効な障害物として出力します。

$$ \text{Output} = \{ \text{center}(cell) \mid C_{cell} \ge \text{threshold} \} $$

### 3. パラメータ設定と挙動
現在の実装値は以下の通りです。

| パラメータ | 値 | 意味と効果 |
| :--- | :--- | :--- |
| `resolution` | 0.1m | 10cm四方の領域を1つの単位として扱います。 |
| `decay_amount` | 1 | 観測がない場合、カウンタは1ずつ減ります。 |
| `hit_increment` | 3 | 障害物を検知すると、カウンタは一気に3増えます。 |
| `threshold` | 5 | カウンタが5以上ないと障害物として認めません。 |
| `max_value` | 10 | カウンタの上限。これにより、障害物が消えた後の「残像」が長く残りすぎるのを防ぎます。 |

**挙動の例:**
*   **ノイズ (1回だけ出現):** $0 \to 3$ (閾値5未満) $\to$ 無視 $\to$ 次フレームで減衰。
*   **実在する壁 (連続出現):**
    *   Frame 1: $0 \to 3$ (無視)
    *   Frame 2: $3 - 1 + 3 = 5$ (**検知!**)
*   **障害物の消失:**
    *   満タン(10)の状態から、観測が途絶えると $10 \to 9 \to \dots \to 4$ (消失判定) まで **6フレーム (約0.6秒)** かかります。

この仕組みにより、**「出現には2フレームで反応し、消失には数フレームの猶予を持つ（チャタリング防止）」** という安定した特性が得られます。

## 実装のポイント
<!-- TODO: Add English translation here -->

*   **グローバル座標管理:**
    *   ロボット中心座標系でグリッドを持つと、ロボットが動くたびに静止障害物のセル位置が変わり、カウンタがリセットされてしまいます。
    *   本実装ではハッシュマップのキーをグローバル座標 `(gx, gy)` とすることで、メモリ効率良く無限のフィールドに対応しつつ、静止物のカウンタを維持しています。
*   **出力の変換:**
    *   Elastic Band はグローバル座標系で障害物入力を受け付けるため、グリッドから抽出した点（グローバル）をそのまま渡します（または必要に応じてローカル変換します）。

この `LocalPersistenceGrid` を通すことで、Elastic Band は「確信のある障害物」だけを相手に計算でき、計算負荷の低減と経路品質の向上を両立しています。
