# 2.12 Elastic Band (局所経路計画)
<!-- TODO: Add English translation here -->

Mobitiaでは、動的な障害物回避のために **Elastic Band (EB)** アルゴリズムを採用しています。これは、初期経路（Global Path）を「ゴムバンド」のような物理モデルに見立て、周囲の障害物からの反発力を受けてリアルタイムに変形させる手法です。

## アルゴリズムの概要
<!-- TODO: Add English translation here -->

Elastic Bandは、経路を構成する一連の点（ノード）に対して、以下の2種類の力を作用させることで形状を最適化します。

1.  **内部力 (Internal Force)**: 経路を滑らかにし、最短距離を保とうとする力（ゴムの収縮力）。
2.  **外部力 (External Force)**: 障害物から遠ざかろうとする力（静電気的な反発力）。
3.  **初期経路への引力 (Global Path Attraction)**: 安全な初期経路（Global Path）から大きく逸脱しないように引き寄せる力。

各フレームにおいて、すべてのノードに対してこれらの力の合力を計算し、位置を更新します。これを数回反復することで、障害物を避けつつ滑らかな経路が生成されます。

## 入力データの安定化 (Noise Filtering)
<!-- TODO: Add English translation here -->

Elastic Band は障害物からの反発力に敏感に反応するため、LiDARのスパイクノイズや一時的な誤検知が入力されると、経路が激しく振動してしまいます。
これを防ぐため、Mobitiaでは生のLiDAR点群を直接EBに入力するのではなく、**[Local Persistence Grid](./14_persistence_grid.md)** と呼ばれるフィルタを通して、「時間的に安定して存在する障害物」のみを抽出して使用しています。

これにより、一瞬だけのノイズは無視され、壁や柱などの実在する障害物に対してのみ滑らかに回避行動をとることができます。

## 実装詳細 (`src/navigation/elastic_band.rs`)
<!-- TODO: Add English translation here -->

### 1. 力の計算モデル

#### 内部力 (Smoothing)
ある点 $P_i$ に対して、前後の点 $P_{i-1}, P_{i+1}$ からの引力を計算します。

$$ F_{int} = k_{int} \cdot ((P_{i-1} - P_i) + (P_{i+1} - P_i)) $$

さらに、カーブをより滑らかにするために、前後の点の中点に向かう力も加える場合があります。

#### 外部力 (Repulsion)
ある点 $P_i$ の周囲にある障害物点群 $O = \{O_1, O_2, ...\}$ のうち、設定された **安全距離 (`obstacle_safety_dist`)** 以内にあるものだけが反発力を及ぼします。

障害物 $O_k$ へのベクトルを $\vec{v} = P_i - O_k$、距離を $d = |\vec{v}|$ とすると、反発力 $F_{ext}$ は以下のように計算されます。

$$ F_{ext} = \sum_{k} k_{ext} \cdot \frac{\vec{v}}{d} \cdot (1.0 - \frac{d}{D_{safety}})^2 $$

- 力の向き: 障害物から点へ向かう方向（常に遠ざける）。
- 力の大きさ: 距離が近いほど強く、安全距離 $D_{safety}$ で 0 になるような2次関数（またはガウス関数）で減衰させます。

#### 初期経路への引力 (Global Path Attraction)
障害物が見えない領域（2D-LiDARの死角にある縁石など）で、経路が内側にショートカットして不可侵領域に入ってしまうのを防ぐため、初期経路（Global Path）への引力を導入しています。

ある点 $P_i$ に対して、初期経路上の最も近い点 $P_{ref}$ を探索し、そこへ引き寄せる力を加えます。

$$ F_{attract} = k_{global} \cdot (P_{ref} - P_i) $$

これにより、動的障害物がない限り、ロボットは事前に走行して安全が確認されている「レコードライン」をトレースしようとします。この力は、障害物回避が必要な場合（強い反発力がある場合）はオーバーライドされますが、障害物を通過すると再び元の安全なルートへ復帰させる効果もあります。

### 2. 移動量の制限 (Stability)
計算された合力 $F_{total} = F_{int} + F_{ext}$ をそのまま位置更新に使うと、計算が発散して経路が振動する恐れがあります。
そのため、1ステップあたりの移動量に上限 (`max_disp`) を設けています。

$$ \Delta P_i = \text{clamp}(F_{total}, \text{max\_disp}) $$
$$ P_i  P_i + \Delta P_i $$

### 3. 経路の再構築 (Refinement & Simplification)
変形によって点の間隔が不均一になるため、動的に点の追加・削除を行います。

- **Refine (密度の維持)**:
    - 隣り合う点の距離が `0.5m` を超えた場合: 中間に新しい点を挿入します。
    - 隣り合う点の距離が `0.1m` 未満になった場合: 点を削除（マージ）します。
- **Simplify (直線の軽量化)**:
    - 連続する3点がほぼ一直線上にあり（内積 $\approx 1.0$）、かつ削除しても間隔が `0.5m` 以内に収まる場合、真ん中の点を削除します。
    - これにより、直線の廊下などでは計算負荷を大幅に削減できます。

## パラメータ調整の指針 (`config.toml`)
<!-- TODO: Add English translation here -->

| パラメータ | 説明 | 推奨値 | 調整の影響 |
| :--- | :--- | :--- | :--- |
| `internal_force_gain` | 経路の張り（収縮力） | 0.5 | 高くすると経路がピンと張り、障害物に近づきやすくなるが形状は安定する。 |
| `external_force_gain` | 障害物からの反発力 | 0.1 | 高くすると障害物を大きく避けるが、狭い場所で振動しやすくなる。 |
| `global_path_gain` | 初期経路への拘束力 | 0.05 ~ 0.2 | 高くすると初期経路を忠実に守る（ショートカット防止）。低くすると回避の自由度が上がる。 |
| `obstacle_safety_dist` | 障害物を検知する距離 (m) | 0.4 ~ 0.6 | 大きくすると早めに避けるが、狭い通路を通れなくなる可能性がある。 |
| `num_iterations` | 1フレームあたりの計算回数 | 5 | 増やすと変形が速く収束するが、CPU負荷が増える。 |

### よくある問題と対策
- **狭いドアで振動する**: `obstacle_safety_dist` を小さくし、両側の壁からの干渉を減らす。
- **壁に近すぎる**: `external_force_gain` を上げる。
- **経路が暴れる**: `internal_force_gain` を上げて形状を安定させるか、移動量制限 (`max_disp`) を厳しくする。
- **カーブで縁石に乗り上げる（ショートカットしすぎる）**: `global_path_gain` を上げて、初期経路への追従性を高める。
