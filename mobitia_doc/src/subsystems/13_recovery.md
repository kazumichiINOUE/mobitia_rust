# 2.13 リカバリー機能 (Recovery Behavior)
<!-- TODO: Add English translation here -->

狭い通路やドアの通過時など、ロボットが障害物に接近しすぎて身動きが取れなくなる（スタックする）状況を防ぐため、Mobitiaは自動的な**リカバリー（復帰）機能**を備えています。

## 概要
<!-- TODO: Add English translation here -->

通常の自律走行（Elastic Band + Pure Pursuit）では、前方に障害物がある場合、それを回避しようとします。しかし、狭い入り口などで回避スペースがない場合、回避行動自体が衝突を引き起こしたり、非常停止距離まで近づいてしまうことがあります。

本機能は、そのような「詰み」状態を検知した際に、**「入ってきた安全な経路（Global Path）をバックで戻る」** ことで、一時的に距離を取り、再アプローチのためのスペースを確保します。

## アルゴリズム詳細 (`src/navigation/recovery.rs`)
<!-- TODO: Add English translation here -->

### 1. トリガー条件 (発動判定)
ロボットは常時、LiDARの点群を監視しています。以下の条件をすべて満たしたときにリカバリーモードへ移行します。

1.  **前方車幅コリドー内の障害物:**
    *   障害物がロボットの進行方向 ($x > 0$) にあり、かつ**ロボットの車幅内 ($|y| < \text{width}/2 + \text{margin}$)** にあること。
    *   以前の「45度コーン」判定では、ロボットの四隅（バンパー角）への衝突を検知しきれない場合があったため、矩形のスイープ領域（コリドー）で判定するように強化されました。
2.  **距離判定:**
    *   その障害物との距離が `recovery_trigger_dist` (設定値) 未満になったこと。
3.  **時間的持続性 (Persistence):**
    *   上記の「危険状態」が **5フレーム連続** で検知されたこと。
    *   LiDARの一瞬のノイズや、ピッチングによる床面検知で誤発動するのを防ぐため、即時発動ではなく「確信」を持ってから発動します。

また、判定の前処理として、**「ロボットの矩形（フットプリント）内部にある点」は自己反射ノイズとして除去** されます。これにより、自分のケーブルやバンパーを障害物と誤認してスタックするのを防ぎます。

### 2. リカバリー動作 (Reverse Path Tracking)
リカバリーが発動すると、以下の手順でバック走行を行います。

1.  **ターゲット設定:** 現在位置から Global Path を逆に辿り、`recovery_target_dist` (例: 0.8m) だけ手前の地点をターゲットとして設定します。
2.  **バック走行制御:**
    *   速度 ($v$): 一定の速度 `-recovery_speed` で後退します。
    *   旋回 ($\omega$): ロボットの「お尻」をターゲットに向けるようにステアリング制御を行います。
    *   制御則: $\omega = -K_p \cdot y_{error}$ （ターゲットが左後ろなら右旋回してお尻を左へ振る）

### 3. 終了条件
以下のいずれかを満たすと、リカバリーモードを終了し、通常の自律走行モードへ復帰します。

*   **障害物がクリアされた:** 前方の障害物との距離が十分に確保された（ヒステリシスを持たせて判定）。
*   **ターゲット到達:** 設定したバック目標地点付近に到達した。
*   **後方障害物検知:** バック中に後ろに障害物を検知した場合（安全のため即時停止）。

## パラメータ設定 (`config.toml`)
<!-- TODO: Add English translation here -->

`[nav]` セクションで以下のパラメータを設定できます。

| パラメータ | 説明 | デフォルト値 | 推奨設定・影響 |
| :--- | :--- | :--- | :--- |
| `recovery_enabled` | 機能の有効/無効 | `true` | 不要な場合は `false` に設定して無効化できます。 |
| `recovery_trigger_dist` | 発動する距離 (m) | `0.2` | 小さすぎると非常停止が先に作動し、大きすぎると頻繁に止まってしまいます。`lidar_avoid_dist` より小さく、かつ物理的な衝突限界より大きい値にします。 |
| `recovery_target_dist` | バックする距離 (m) | `0.8` | どれくらい戻って仕切り直すか。長すぎると後ろの壁にぶつかるリスクが増えます。 |
| `recovery_speed` | バック速度 (m/s) | `0.15` | 速すぎると制御が乱れるため、低速（0.1~0.2）を推奨します。 |

## トラブルシューティング
<!-- TODO: Add English translation here -->

*   **狭いドアを通れない (バックしてしまう):**
    *   `recovery_trigger_dist` を小さくしてみてください（例: 0.15）。
    *   それでもダメな場合、`config.toml` の `robot.width` 設定が実機より大きすぎて、Elastic Band がドアを通れないと判断している可能性があります。

*   **バック中に壁にぶつかる:**
    *   本機能は Global Path 上を戻ろうとしますが、完全に正確な軌跡追従ではありません。`recovery_target_dist` を短くするか、後方にもLiDARを搭載して安全性を高めることを検討してください。
