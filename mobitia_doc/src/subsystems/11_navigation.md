# 2.11 非同期サブシステム: ナビゲーション (`src/navigation/`)
このモジュールは、ロボットの経路計画と追従、自己位置推定など、ナビゲーションに関する機能を提供します。

## ナビゲーションモード (Nav Mode)
`nav` コマンドが実行されると、アプリケーションはナビゲーションモードに切り替わります。このモードは、ナビゲーションに関連する全ての機能（テスト実行、ナビゲーション開始など）の結果や状態を視覚的に表示するための専用描画モードです。地図、ロボットの自己位置、およびLiDAR計測データがリアルタイムに描画されます。

## コマンド
`nav` コマンドは、ナビゲーション機能の制御を行います。

### `nav test <path>`
指定されたパス（例: マップファイル、経路ファイル）を使用してナビゲーションテストを実行します。テストの進行状況や結果はナビゲーションモードで視覚化されます。

### `nav start <path>`
指定されたパスの経路を読み込み、ナビゲーションを開始します。ロボットの移動や経路追従の様子はナビゲーションモードで視覚化されます。

### 共通の初期処理と表示
`nav test <path>` および `nav start <path>` コマンドの実行時には、`<path>` で指定されたディレクトリから以下のファイルが読み込まれます。
- `occMap.png`: 占有格子地図の画像ファイル。
- `map_info.toml`: 地図情報（解像度、原点など）を記述した設定ファイル。
- `trajectory.txt`: ナビゲーションのターゲットポイントのXY座標（1列目と2列目）が記述されたファイル。

読み込まれた `occMap.png` は画面全体に表示されます。また、`map_info.toml` の情報に基づいて地図の原点とXY軸が目立たない色で描画されます。`trajectory.txt` から読み取られたターゲットポイントも、同様に目立たない色で地図上に表示されます。

### `nav stop`
現在実行中のナビゲーションプロセスを停止します。このコマンドの実行後、アプリケーションの描画モードはデフォルトでLiDARモードに戻ります。

## 座標系と地図データの仕様
本システムにおけるナビゲーションでは、ワールド座標系とグリッド座標系（地図画像）の間で正確な変換が求められます。以下の仕様に基づいて実装されています。

### 1. 座標系の定義
- **ワールド座標系 (World Coordinates)**:
    - X軸: 右（東）が正。
    - Y軸: 上（北）が正。
    - 単位: メートル (m)。
    - 一般的なデカルト座標系およびROSの標準（ENU: East-North-Up）に準拠します。

- **グリッド座標系 (Grid/Image Coordinates)**:
    - 原点 (0, 0): 地図画像の**左上（北西）**。
    - U軸 (Column): 右に向かって増加。ワールドX軸に対応。
    - V軸 (Row): **下に向かって増加**。ワールドY軸とは逆向き（北から南へ）。

### 2. 地図情報 (`map_info.toml`)
- `origin`: 地図画像の**左上（北西端）**のワールド座標 `[x, y, theta]` を指します。
- `resolution`: 1ピクセルあたりのメートル数 (m/pixel)。

### 3. 座標変換式
ワールド座標 $(x, y)$ からグリッドインデックス $(u, v)$ への変換は以下の式で行います。

$$ u = \lfloor \frac{x - origin\_x}{resolution} \rfloor $$
$$ v = \lfloor \frac{origin\_y - y}{resolution} \rfloor $$

ここで注意すべきは $v$ (行インデックス) の計算です。ワールドY座標は北へ行くほど大きくなりますが、グリッドの行インデックスは南へ行くほど（上から下へ）大きくなります。そのため、$(origin\_y - y)$ という減算になります。

### 4. 地図データの配色仕様
地図画像 (`occMap.png`) および内部データ (`OccupancyGrid`) の配色は以下のように定義されます。

- **黒 (0, 0, 0)**: 占有領域 (Occupied) / 壁。確率 $\approx 1.0$。
- **白 (255, 255, 255)**: 自由領域 (Free) / 通路。確率 $\approx 0.0$。
- **グレー (128, 128, 128)**: 未計測領域 (Unknown)。確率 $\approx 0.5$。

`map load` コマンドによる保存時もこの仕様に従って画像が生成されます。

## アーキテクチャと設計方針

### モジュール構成
ナビゲーション機能は `src/navigation/` ディレクトリ以下のモジュールに集約されています。

- **`src/navigation/mod.rs`**: `NavigationManager` 構造体とその実装が含まれます。これがナビゲーションサブシステムのメインエントリーポイントです。
- **`src/navigation/localization.rs`**: 自己位置推定ロジック（現在、再実装中）。
- **`src/navigation/pure_pursuit.rs`**: 経路追従ロジック（Pure Pursuitアルゴリズム）。

### 地図データの扱いと高精度化
ナビゲーションの信頼性を高めるため、起動時の地図データ読み込みと内部表現を高度化します。

1.  **データソース**: ナビゲーション開始時（`nav test` または `nav start`）、システムは画像 (`occMap.png`) だけに頼らず、SLAM生成時に保存された**点群データ (`scans.json`)** を直接読み込みます。
2.  **地図の再構築**: 読み込んだ点群データから、メモリ上で `OccupancyGrid` を再構築します。これにより、各セルには占有確率だけでなく、**法線ベクトル (Normal Vector)** や **エッジ強度 (Edge-ness)** といった幾何学的特徴量が埋め込まれます。
3.  **特徴量ベースのマッチング**: 自己位置推定 (DE) において、LiDAR点群と地図とのマッチングを行う際、これらの特徴量を評価関数に組み込みます。これにより、壁の向きや角（コーナー）の情報を活用した、より堅牢な位置推定が可能になります。

### `NavigationManager`
`src/app.rs` の肥大化を防ぐため、ナビゲーションに関連する状態とロジックは `NavigationManager` にカプセル化されています。`MyApp` はこのマネージャーのインスタンスを保持し、処理を委譲します。

#### 管理する状態
- **地図データ**: `nav_map_texture`, `nav_map_bounds`, `occupancy_grid`
- **経路情報**: `nav_trajectory_points`
- **現在のターゲット**: `current_nav_target`
- **ロボットの現在姿勢**: `current_robot_pose`
- **オドメトリ履歴**: `last_odom`（前回フレームの値を保持し、差分計算に使用）

### 自己位置更新ロジック
`NavigationManager::update` メソッドは毎フレーム呼び出され、以下の手順でロボットの自己位置を更新します。

1.  **オドメトリ差分の計算**: モーター制御スレッドから得られる現在のオドメトリ値と、前回フレームの値 (`last_odom`) との差分を計算します。
2.  **座標変換**: グローバル座標系での差分を、ロボットのローカル座標系での移動量に変換します。
3.  **姿勢の更新**: 変換された移動量を現在のロボット姿勢 (`current_robot_pose`) に適用します。

```rust
// src/navigation/mod.rs の update メソッド（抜粋）
pub fn update(&mut self, current_odom: (f32, f32, f32)) {
    // 1. Odometry Update
    if let Some((last_x, last_y, last_theta)) = self.last_odom {
        let (curr_x, curr_y, curr_theta) = current_odom;
        // ... (差分計算と座標変換) ...
        
        let movement = Isometry2::new(
            nalgebra::Vector2::new(delta_x_local, delta_y_local),
            delta_theta,
        );
        self.current_robot_pose *= movement;
    }
    self.last_odom = Some(current_odom);
}
```

このオドメトリ更新に加え、LiDAR点群と地図とのマッチング（スキャンマッチング）による補正（自己位置推定）が組み込まれる予定です。

## サジェスト
`nav` コマンドとそのサブコマンド (`test`, `start`, `stop`)、および `<path>` 引数は、コマンド入力時のサジェストの対象となります。

```